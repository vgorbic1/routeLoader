<?php
  if (isset($_POST["data"])) {
    //$test = '[[["tag","lane","pics","sign","cycle","frame","units","island","prefix","dateshot","delivery","milepost","cds_rteno","imagepath","session_name"],["Started Cameras","CTR","500","+","2018","00001","MILE","Oahu","CR","01/27/2019","delivery 3","0.0000","6666","Oahu_CR_6666_CTR_-_2018","Oahu_CR_6666_CTR_-_2018"],["Started Odometer","CTR","500","+","2018","00035","MILE","Oahu","CR","01/27/2019","delivery 3","0.0000","6666","Oahu_CR_6666_CTR_-_2018","Oahu_CR_6666_CTR_-_2018"],["Edit Point","CTR","500","+","2018","00200","MILE","Oahu","CR","01/27/2019","delivery 3","0.3309","6666","Oahu_CR_6666_CTR_-_2018","Oahu_CR_6666_CTR_-_2018"],["Edit Point","CTR","500","+","2018","00210","MILE","Oahu","CR","01/27/2019","delivery 3","0.3409","6666","Oahu_CR_6666_CTR_-_2018","Oahu_CR_6666_CTR_-_2018"],["Edit Point","CTR","500","+","2018","00220","MILE","Oahu","CR","01/27/2019","delivery 3","0.3509","6666","Oahu_CR_6666_CTR_-_2018","Oahu_CR_6666_CTR_-_2018"],["Edit Point","CTR","500","+","2018","00230","MILE","Oahu","CR","01/27/2019","delivery 3","0.4309","6666","Oahu_CR_6666_CTR_-_2018","Oahu_CR_6666_CTR_-_2018"],["Edit Point","CTR","500","+","2018","00240","MILE","Oahu","CR","01/27/2019","delivery 3","0.5309","6666","Oahu_CR_6666_CTR_-_2018","Oahu_CR_6666_CTR_-_2018"],["Edit Point","CTR","500","+","2018","00250","MILE","Oahu","CR","01/27/2019","delivery 3","0.5409","6666","Oahu_CR_6666_CTR_-_2018","Oahu_CR_6666_CTR_-_2018"],["Edit Point","CTR","500","+","2018","00260","MILE","Oahu","CR","01/27/2019","delivery 3","0.5509","6666","Oahu_CR_6666_CTR_-_2018","Oahu_CR_6666_CTR_-_2018"],["Edit Point","CTR","500","+","2018","00300","MILE","Oahu","CR","01/27/2019","delivery 3","0.5609","6666","Oahu_CR_6666_CTR_-_2018","Oahu_CR_6666_CTR_-_2018"],["Edit Point","CTR","500","+","2018","00400","MILE","Oahu","CR","01/27/2019","delivery 3","0.6709","6666","Oahu_CR_6666_CTR_-_2018","Oahu_CR_6666_CTR_-_2018"],["Stopped Odometer","CTR","500","+","2018","00419","MILE","Oahu","CR","01/27/2019","delivery 3","0.7702","6666","Oahu_CR_6666_CTR_-_2018","Oahu_CR_6666_CTR_-_2018"],["Stopped Cameras","CTR","500","+","2018","00469","MILE","Oahu","CR","01/27/2019","delivery 3","0.7702","6666","Oahu_CR_6666_CTR_-_2018","Oahu_CR_6666_CTR_-_2018"]],[["tag","lane","pics","sign","cycle","frame","units","island","prefix","dateshot","delivery","milepost","cds_rteno","imagepath","session_name"],["Started Cameras","CTR","500","+","2018","00001","MILE","Oahu","CR","01/27/2019","delivery 3","0.0000","7777","Oahu_CR_7777_CTR_-_2018","Oahu_CR_7777_CTR_-_2018"],["Started Odometer","CTR","500","+","2018","00035","MILE","Oahu","CR","01/27/2019","delivery 3","0.0000","7777","Oahu_CR_7777_CTR_-_2018","Oahu_CR_7777_CTR_-_2018"],["Edit Point","CTR","500","+","2018","00200","MILE","Oahu","CR","01/27/2019","delivery 3","0.3309","7777","Oahu_CR_7777_CTR_-_2018","Oahu_CR_7777_CTR_-_2018"],["Edit Point","CTR","500","+","2018","00210","MILE","Oahu","CR","01/27/2019","delivery 3","0.3409","7777","Oahu_CR_7777_CTR_-_2018","Oahu_CR_7777_CTR_-_2018"],["Edit Point","CTR","500","+","2018","00220","MILE","Oahu","CR","01/27/2019","delivery 3","0.3509","7777","Oahu_CR_7777_CTR_-_2018","Oahu_CR_7777_CTR_-_2018"],["Edit Point","CTR","500","+","2018","00230","MILE","Oahu","CR","01/27/2019","delivery 3","0.4309","7777","Oahu_CR_7777_CTR_-_2018","Oahu_CR_7777_CTR_-_2018"],["Edit Point","CTR","500","+","2018","00240","MILE","Oahu","CR","01/27/2019","delivery 3","0.5309","7777","Oahu_CR_7777_CTR_-_2018","Oahu_CR_7777_CTR_-_2018"],["Edit Point","CTR","500","+","2018","00250","MILE","Oahu","CR","01/27/2019","delivery 3","0.5409","7777","Oahu_CR_7777_CTR_-_2018","Oahu_CR_7777_CTR_-_2018"],["Edit Point","CTR","500","+","2018","00260","MILE","Oahu","CR","01/27/2019","delivery 3","0.5509","7777","Oahu_CR_7777_CTR_-_2018","Oahu_CR_7777_CTR_-_2018"],["Edit Point","CTR","500","+","2018","00300","MILE","Oahu","CR","01/27/2019","delivery 3","0.5609","7777","Oahu_CR_7777_CTR_-_2018","Oahu_CR_7777_CTR_-_2018"],["Edit Point","CTR","500","+","2018","00400","MILE","Oahu","CR","01/27/2019","delivery 3","0.6709","7777","Oahu_CR_7777_CTR_-_2018","Oahu_CR_7777_CTR_-_2018"],["Stopped Odometer","CTR","500","+","2018","00419","MILE","Oahu","CR","01/27/2019","delivery 3","0.7702","7777","Oahu_CR_7777_CTR_-_2018","Oahu_CR_7777_CTR_-_2018"],["Stopped Cameras","CTR","500","+","2018","00469","MILE","Oahu","CR","01/27/2019","delivery 3","0.7702","7777","Oahu_CR_7777_CTR_-_2018","Oahu_CR_7777_CTR_-_2018"]]]';
    $json_routes = $_POST["data"];
    $routes = json_decode($json_routes);
    //$test_names = 'Oahu_CR_6666_CTR_-_2018,Oahu_CR_7777_CTR_-_2018';
    $json_names = $_POST["names"];
    $names = explode(",", $json_names);
    $template = $_POST['template'];
    $error_message = "";
    $db_host = "";
    $db_name = "";
    $db_name = "";
    $db_name = "";
    $db_table = "";

    // get database creds from template
    $config = parse_ini_file("config.ini");
    try {     
      $db = new PDO("mysql:host={$config['host']};dbname={$config['db']};charset={$config['charset']}", $config['user'], $config['pass']);
      $db->setAttribute(PDO::ATTR_ERRMODE,PDO::ERRMODE_EXCEPTION);
      $query_select = "SELECT DB_HOST, DB_SCHEMA, DB_CHARSET, DB_USER, DB_PASS, TBL_ROUTES FROM TEMPLATES
                       JOIN `DATABASES` ON TEMPLATES.DATABASE = DATABASES.DB_NAME WHERE NAME = :template";
      $stmt_select = $db->prepare($query_select);
      $stmt_select->execute( array(":template"=> $template) );
  
      if ($row = $stmt_select->fetch() ) {
        $db_host = $row["DB_HOST"];
        $db_name = $row["DB_SCHEMA"];
        $db_charset = $row["DB_CHARSET"];
        $db_user = $row["DB_USER"];
        $db_pass = $row["DB_PASS"];
        $db_table = $row["TBL_ROUTES"];
      } else {
        $error_message = "{\"error\": \"unable to retrieve information\"}";
      } 
    } catch (PDOException $e){
      $error_message = "{\"error\": \"internal error {$e}\"}";
      // add $e to error log
    }

    if ($error_message === "") {

      include("functions.php");
     
      $rows_to_delete = create_delete_set($names);
      $rows_to_insert = create_insert_set($routes);
      $db_user = simple_crypt($db_user, "d", $config['salt'], $config['pepper']);
      $db_pass = simple_crypt($db_pass, "d", $config['salt'], $config['pepper']);

      $pdo = new PDO("mysql:host={$db_host};dbname={$db_name};charset={$db_charset}", $db_user, $db_pass);
      if (!pdo_multi_delete($db_table, $rows_to_delete, $pdo)) {
        echo "{\"error\": \"cannot delete records\"}";
      } else {
        $num_rows_inserted = pdo_multi_insert($db_table, $rows_to_insert, $pdo);
        echo "{\"success\": \"Success! Route(s) loaded and $num_rows_inserted records inserted.\"}";
      }    
    } else {
      echo $error_message;
    }
  } else {
    echo "{\"error\": \"cannot load route(s)\"}";
  }